@model Realtors_Portal.Models.ViewModel.ListingCreateViewModel

@{
    Layout = null;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />

<link href="~/Content/source/css/listing.css" rel="stylesheet" />

<div class="container my-4">
    <h3 class="step-header">Tạo tin đăng</h3>

    @using (Html.BeginForm("Create", "Listings", FormMethod.Post, new { enctype = "multipart/form-data" }))
    {
        @Html.AntiForgeryToken()
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        @Html.HiddenFor(m => m.CustomerID)

        <!-- Thông tin cơ bản -->
        <div class="card-section">
            <h5 class="section-title"><i class="bi bi-house-door"></i> Thông tin cơ bản</h5>
            <div class="row g-3">
                <div class="col-md-6">
                    @Html.LabelFor(m => m.Title, "Tiêu đề tin")
                    @Html.TextBoxFor(m => m.Title, new { @class = "form-control", placeholder = "Nhập tiêu đề" })
                    @Html.ValidationMessageFor(m => m.Title, "", new { @class = "text-danger" })
                </div>
                <div class="col-md-6">
                    @Html.LabelFor(m => m.Price, "Giá (VNĐ)")
                    @Html.TextBoxFor(m => m.Price, new { @class = "form-control", placeholder = "VD: 2500000000" })
                </div>
                <div class="col-md-6">
                    @Html.LabelFor(m => m.Area, "Diện tích (m²)")
                    @Html.TextBoxFor(m => m.Area, new { @class = "form-control", placeholder = "VD: 85" })
                </div>
                <div class="col-md-6">
                    @Html.LabelFor(m => m.PropertyTypeID, "Loại BĐS")
                    @Html.DropDownListFor(m => m.PropertyTypeID, (SelectList)ViewBag.PropertyTypeID, "-- Chọn loại --", new { @class = "form-select" })
                </div>
                <div class="col-md-6">
                    @Html.LabelFor(m => m.LegalStatus, "Tình trạng pháp lý")
                    @Html.DropDownListFor(m => m.LegalStatus, (SelectList)ViewBag.LegalStatus, "-- Chọn tình trạng --", new { @class = "form-select" })
                </div>
                <div class="col-md-6">
                    @Html.LabelFor(m => m.CategoryID, "Cho bán/thuê")
                    @Html.DropDownListFor(m => m.CategoryID, (SelectList)ViewBag.CategoryID, "-- Cho bán hay thuê --", new { @class = "form-select" })
                </div>
                <div class="col-12">
                    @Html.LabelFor(m => m.Description, "Mô tả chi tiết")
                    @Html.TextAreaFor(m => m.Description, new { @class = "form-control", rows = 3, placeholder = "Mô tả chi tiết bất động sản..." })
                </div>
            </div>
        </div>

        <!-- Địa chỉ -->
        <div class="card-section">
            <h5 class="section-title"><i class="bi bi-geo-alt"></i> Địa chỉ</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    @Html.DropDownList("CityID", (SelectList)ViewBag.CityID, "-- Chọn Tỉnh/TP --", new { @class = "form-select", id = "CityID" })
                </div>
                <div class="col-md-3">
                    <select id="DistrictID" name="DistrictID" class="form-select"><option value="">-- Chọn Quận/Huyện --</option></select>
                </div>
                <div class="col-md-3">
                    <select id="WardID" name="WardID" class="form-select"><option value="">-- Chọn Phường/Xã --</option></select>
                </div>
                <div class="col-md-3">
                    <select id="AddressID" name="AddressID" class="form-select"><option value="">-- Chọn Đường/Phố --</option></select>
                </div>
                <div class="col-12">
                    @Html.LabelFor(m => m.Location, "Vị trí cụ thể")
                    @Html.TextBoxFor(m => m.Location, new { @class = "form-control", placeholder = "VD: Ngách 123, tòa nhà ABC..." })
                </div>
            </div>
            <div class="mt-3 border rounded overflow-hidden" style="height:250px;">
                <iframe width="100%" height="100%" frameborder="0" style="border:0"
                        src="https://www.google.com/maps?q=Hồ+Chí+Minh&output=embed" allowfullscreen>
                </iframe>
            </div>

        </div>

        <!-- Nội thất -->
        <div class="card-section">
            <h5 class="section-title"><i class="bi bi-door-closed"></i> Nội thất & tiện ích</h5>
            <div class="row g-3">
                <div class="col-md-3">
                    @Html.LabelFor(m => m.Bedrooms, "Phòng ngủ")
                    @Html.TextBoxFor(m => m.Bedrooms, new { @class = "form-control", type = "number" })
                </div>
                <div class="col-md-3">
                    @Html.LabelFor(m => m.Bathrooms, "Phòng tắm")
                    @Html.TextBoxFor(m => m.Bathrooms, new { @class = "form-control", type = "number" })
                </div>
                <div class="col-md-3">
                    @Html.LabelFor(m => m.Floors, "Số tầng")
                    @Html.TextBoxFor(m => m.Floors, new { @class = "form-control", type = "number" })
                </div>
                <div class="col-md-3">
                    @Html.LabelFor(m => m.Direction, "Hướng nhà")
                    @Html.DropDownListFor(m => m.Direction, (SelectList)ViewBag.Direction, "-- Chọn hướng --", new { @class = "form-select" })
                </div>
                <div class="col-12">
                    @Html.LabelFor(m => m.Furniture, "Mô tả nội thất")
                    @Html.TextAreaFor(m => m.Furniture, new { @class = "form-control", rows = 2 })
                </div>
            </div>
        </div>

        <!-- Ảnh -->
        <div class="card-section">
            <h5 class="section-title"><i class="bi bi-image"></i> Hình ảnh</h5>
            <div id="imgList"></div>
            <button type="button" id="addImgItem" class="btn btn-outline-danger mt-2">
                <i class="bi bi-plus-circle"></i> Thêm ảnh
            </button>
        </div>
        <h4 class="text-secondary mt-4 mb-3">Gói tin đăng</h4>
        <div class="mb-3">
            @Html.DropDownListFor(m => m.PackageID, (SelectList)ViewBag.PackageID, "-- Chọn gói --", new { @class = "form-control" })
            @Html.ValidationMessageFor(m => m.PackageID, "", new { @class = "text-danger" })
        </div>
        <!-- Gói tin -->
        <!--<h5 class="section-title"><i class="bi bi-box-seam"></i> Chọn loại tin</h5>
        <p class="text-muted">
            <i class="bi bi-lightbulb"></i> Tin VIP có lượt liên hệ cao hơn Tin Thường từ 8–30 lần
        </p>

        <div class="row g-3 mb-4" id="package-options">-->
            <!-- VIP Kim Cương -->
            <!--<div class="col-md-3">
                <div class="card package-card" data-package="Diamond">
                    <div class="card-body text-center">
                        <h6 class="fw-bold text-danger"><i class="bi bi-gem"></i> VIP Kim Cương</h6>
                        <small class="text-muted">Hiển thị trên cùng</small>
                        <div class="my-2 text-danger fw-semibold">×30 lượt liên hệ</div>
                        <div class="fw-bold">340.000 đ/ngày</div>
                    </div>
                </div>
            </div>-->

            <!-- VIP Vàng -->
            <!--<div class="col-md-3">
                <div class="card package-card" data-package="Gold">
                    <div class="card-body text-center">
                        <h6 class="fw-bold text-warning"><i class="bi bi-trophy"></i> VIP Vàng</h6>
                        <small class="text-muted">Dưới VIP Kim Cương</small>
                        <div class="my-2 text-warning fw-semibold">×15 lượt liên hệ</div>
                        <div class="fw-bold">134.000 đ/ngày</div>
                    </div>
                </div>
            </div>-->

            <!-- VIP Bạc -->
            <!--<div class="col-md-3">
                <div class="card package-card" data-package="Silver">
                    <div class="card-body text-center">
                        <h6 class="fw-bold text-info"><i class="bi bi-award"></i> VIP Bạc</h6>
                        <small class="text-muted">Dưới VIP Vàng</small>
                        <div class="my-2 text-info fw-semibold">×8 lượt liên hệ</div>
                        <div class="fw-bold">61.900 đ/ngày</div>
                    </div>
                </div>
            </div>-->

            <!-- Tin thường -->
            <!--<div class="col-md-3">
                <div class="card package-card" data-package="Normal">
                    <div class="card-body text-center position-relative">
                        <div class="badge bg-danger position-absolute top-0 end-0 m-2">Khuyến mãi hot!</div>
                        <h6 class="fw-bold text-secondary"><i class="bi bi-list"></i> Tin thường</h6>
                        <small class="text-muted">Hiển thị dưới cùng</small>
                        <div class="my-2 text-secondary fw-semibold">0 đ/ngày <span class="text-danger">(-100%)</span></div>
                    </div>
                </div>
            </div>
        </div>-->

        <!-- Thời gian đăng -->
        <!--<div class="card p-3 mb-4 border-0 shadow-sm">
            <h6 class="fw-bold mb-3">Đăng dài ngày hơn, tiết kiệm hơn!</h6>
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="duration-btn disabled">10 ngày<br /><small>Ngừng hỗ trợ</small></button>
                <button type="button" class="duration-btn active" data-duration="15">15 ngày<br /><span class="text-danger fw-semibold">0 đ/ngày (-100%)</span></button>
                <button type="button" class="duration-btn" data-duration="30">30 ngày<br /><span class="text-danger fw-semibold">0 đ/ngày (-100%)</span></button>
                <button type="button" class="duration-btn" data-duration="60">60 ngày<br /><span class="text-muted">2.700 đ/ngày</span></button>
            </div>
        </div>

        <p class="text-muted small">
            <i class="bi bi-info-circle"></i>
            Đối với Tin Thường phân mục bán, thời gian đăng tin được điều chỉnh thành 15, 30 hoặc 60 ngày, áp dụng từ ngày 15/10/2025.
        </p>

        @Html.HiddenFor(m => m.PackageID)
        @Html.Hidden("DurationDays")-->



        <style>
            .package-card {
                cursor: pointer;
                border: 2px solid transparent;
                border-radius: 12px;
                transition: all 0.2s ease;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }

                .package-card:hover {
                    border-color: #ccc;
                    transform: translateY(-3px);
                }

                .package-card.active {
                    border-color: #d00;
                    box-shadow: 0 0 0 3px rgba(255,0,0,0.1);
                }

            .duration-btn {
                flex: 1;
                text-align: center;
                background: #fff;
                border: 2px solid #ddd;
                border-radius: 10px;
                padding: 10px;
                min-width: 120px;
                font-size: 14px;
                transition: 0.2s;
            }

                .duration-btn:hover {
                    border-color: #bbb;
                }

                .duration-btn.active {
                    border-color: #d00;
                    background: #fff5f5;
                }

                .duration-btn.disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
        </style>


        <div class="text-center">
            <button type="submit" class="btn-primary-custom">
                <i class="bi bi-send"></i> Đăng tin
            </button>
            <a href="@Url.Action("Index", "Customers")" class="btn btn-outline-secondary ms-2">Hủy</a>
        </div>
    }
</div>


<script>
    const locationInput = document.getElementById("Location");
    locationInput.addEventListener("blur", () => {
        const addr = encodeURIComponent(locationInput.value);
        document.querySelector("iframe").src = `https://www.google.com/maps?q=${addr}&output=embed`;
    });
</script>

<script>
    //Get districts by city
    //Author: Nguyen Manh Hung, Le Quang Dung
    document.getElementById("CityID").addEventListener("change", function () {
        var CityID = this.value;
        var districtSelect = document.getElementById("DistrictID");
        var wardSelect = document.getElementById("WardID");
        var addressSelect = document.getElementById("AddressID");

        //Hiện đang tải
        districtSelect.innerHTML = '<option>Đang tải...</option>';

        //Lấy dữ liệu csdl
        fetch(`/Districts/GetByCityID?CityID=${encodeURIComponent(CityID)}`)
            .then(response => response.json())
            .then(data => {
                let options = '<option value>-- Chọn Quận/Huyện --</option>';
                data.forEach(d => {
                    options += `<option value="${d.DistrictID}">${d.DistrictName}</option>`;
                });
                districtSelect.innerHTML = options;
                wardSelect.innerHTML = '<option value>-- Chọn Phường/Xã --</option>';
                addressSelect.innerHTML = '<option value>-- Chọn Đường/Phố --</option>';
            });
    });

    //Get wards by districts
    //Author: Nguyen Manh Hung, Le Quang Dung
    document.getElementById("DistrictID").addEventListener("change", function () {
        var DistrictID = this.value;
        var wardSelect = document.getElementById("WardID");
        var addressSelect = document.getElementById("AddressID");

        //Hiện đang tải
        wardSelect.innerHTML = '<option>Đang tải...</option>';

        //Lấy dữ liệu csdl
        fetch(`/Wards/GetByDistrictID?DistrictID=${encodeURIComponent(DistrictID)}`)
            .then(response => response.json())
            .then(data => {
                let options = '<option value>-- Chọn Phường/Xã --</option>';
                data.forEach(w => {
                    options += `<option value="${w.WardID}">${w.WardName}</option>`;
                });
                wardSelect.innerHTML = options;
                addressSelect.innerHTML = '<option value>-- Chọn Đường/Phố --</option>';
            });
    });

    //Get addresses by wards
    //Author: Nguyen Manh Hung, Le Quang Dung
    document.getElementById("WardID").addEventListener("change", function () {
        var WardID = this.value;
        var addressSelect = document.getElementById("AddressID");

        //Hiện đang tải
        addressSelect.innerHTML = '<option>Đang tải...</option>';

        //Lấy dữ liệu csdl
        fetch(`/Addresses/GetByWardID?WardID=${encodeURIComponent(WardID)}`)
            .then(response => response.json())
            .then(data => {
                let options = '<option value>-- Chọn Đường/Phố --</option>';
                data.forEach(a => {
                    options += `<option value="${a.AddressID}">${a.Street}</option>`;
                });
                addressSelect.innerHTML = options;
            });
    });

    //Tạo upload từng ảnh
    //Author: Le Quang Dung
    document.getElementById('addImgItem').addEventListener('click', function () {
        const imgList = document.getElementById('imgList');

        //Tạo khung để chứa input file, preview ảnh đó và nút xóa
        const imgItem = document.createElement('div');
        imgItem.className = 'd-flex align-items-center';

        //Tạo thẻ input
        const img = document.createElement('input');
        img.type = 'file';
        img.name = 'Images';
        img.accept = 'image/*';
        img.className = 'form-control';

        //Tạo thẻ preview
        const preview = document.createElement('img');
        preview.style.maxWidth = '100px';
        preview.style.maxWidth = '100px';
        preview.style.objectFit = 'cover';
        preview.style.display = 'none';
        preview.style.cursor = 'pointer';

        //Tạo nút xóa
        const x = document.createElement('button');
        x.type = 'button';
        x.textContent = 'x';
        x.className = 'btn btn-danger';
        x.addEventListener('click', function () {
            imgItem.remove();
        });

        //Gán ảnh vừa input vào thẻ preview
        img.addEventListener('change', function (a) {
            const file = a.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    preview.src = event.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        });

        //Click vào để xem rõ ảnh
        preview.addEventListener('click', function () {
            const preImg = document.getElementById('previewImg');
            preImg.src = preview.src;
            const modal = new bootstrap.Modal(document.getElementById('imgPreviewItem'));
            modal.show();
        });

        //Thêm các thẻ con vào cha của chúng
        imgItem.appendChild(img);
        imgItem.appendChild(preview);
        imgItem.appendChild(x);
        imgList.appendChild(imgItem);
    });
</script>
